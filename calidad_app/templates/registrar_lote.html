{% extends 'base.html' %}
{% block title %}Registrar Lote · {{ proyecto.nombre }}{% endblock %}
{% block content %}
<div class="card p-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h5 mb-0">Registrar Lote</h1>
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'lotes_por_proyecto' proyecto.id %}">Volver a Lotes</a>
  </div>

  <div class="mb-3">
    <strong>Proyecto:</strong> {{ proyecto.nombre }}
    {% if proyecto.cliente %}<span class="text-muted">— {{ proyecto.cliente }}</span>{% endif %}
  </div>

  <form method="post" enctype="multipart/form-data" class="row g-3" id="loteForm">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="col-12">
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      </div>
    {% endif %}

    <div class="col-md-4">
      <label class="form-label" for="{{ form.id_lote.id_for_label }}">ID Lote</label>
      {{ form.id_lote }}
      {% if form.id_lote.errors %}<div class="text-danger small">{{ form.id_lote.errors }}</div>{% endif %}
    </div>

    <div class="col-md-4">
      <label class="form-label" for="{{ form.fecha.id_for_label }}">Fecha</label>
      {{ form.fecha }}
      {% if form.fecha.errors %}<div class="text-danger small">{{ form.fecha.errors }}</div>{% endif %}
    </div>

    <div class="col-md-4">
      <label class="form-label" for="{{ form.numero_partes.id_for_label }}">Número de partes</label>
      {{ form.numero_partes }}
      {% if form.numero_partes.errors %}<div class="text-danger small">{{ form.numero_partes.errors }}</div>{% endif %}
    </div>

    <div class="col-12">
      <div class="alert alert-info py-2">
        <strong>Nota:</strong> Se validan formatos por tipo: PDF/Excel/CSV para reportes; DXF/DWG para planos/tolerancias; JPG/PNG/PDF para fotos.
      </div>
    </div>

    <div class="col-md-6">
      <label class="form-label" for="{{ form.analisis_espectrometrico.id_for_label }}">Análisis espectrométrico</label>
      {{ form.analisis_espectrometrico }}
      {% if form.analisis_espectrometrico.errors %}<div class="text-danger small">{{ form.analisis_espectrometrico.errors }}</div>{% endif %}
    </div>

    <div class="col-md-6">
      <label class="form-label" for="{{ form.tolerancia_geometrica.id_for_label }}">Tolerancia geométrica</label>
      {{ form.tolerancia_geometrica }}
      {% if form.tolerancia_geometrica.errors %}<div class="text-danger small">{{ form.tolerancia_geometrica.errors }}</div>{% endif %}
    </div>

    <div class="col-md-6">
      <label class="form-label" for="{{ form.prueba_dureza.id_for_label }}">Prueba de dureza</label>
      {{ form.prueba_dureza }}
      {% if form.prueba_dureza.errors %}<div class="text-danger small">{{ form.prueba_dureza.errors }}</div>{% endif %}
    </div>

    <div class="col-md-6">
      <label class="form-label" for="{{ form.prueba_tension.id_for_label }}">Prueba de tensión</label>
      {{ form.prueba_tension }}
      {% if form.prueba_tension.errors %}<div class="text-danger small">{{ form.prueba_tension.errors }}</div>{% endif %}
    </div>

    <div class="col-md-6">
      <label class="form-label" for="{{ form.evidencia_fotografica.id_for_label }}">Evidencia fotográfica</label>
      {{ form.evidencia_fotografica }}
      {% if form.evidencia_fotografica.errors %}<div class="text-danger small">{{ form.evidencia_fotografica.errors }}</div>{% endif %}
    </div>

    <div class="col-md-6">
      <label class="form-label" for="{{ form.plano_original.id_for_label }}">Plano original</label>
      {{ form.plano_original }}
      {% if form.plano_original.errors %}<div class="text-danger small">{{ form.plano_original.errors }}</div>{% endif %}
    </div>

    <div class="col-12 d-flex gap-2">
      <button id="btnSubmit" class="btn btn-primary" type="submit">Guardar</button>
      <a class="btn btn-light" href="{% url 'lotes_por_proyecto' proyecto.id %}">Cancelar</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const form = document.getElementById('loteForm');
    const btn = document.getElementById('btnSubmit');
    if(form && btn){
      form.addEventListener('submit', function(){
        btn.disabled = true;
        btn.textContent = 'Guardando...';
      });
    }
  })();
</script>
{% endblock %}
